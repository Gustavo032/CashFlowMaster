{% extends "base.html" %}

{% block title %}Mapeamentos Contábeis - CashFlowMaster{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Mapeamentos Contábeis</h1>
            <div class="btn-group">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#presetModal">
                    <i data-feather="save"></i>
                    Presets
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createMappingModal">
                    <i data-feather="plus"></i>
                    Novo Mapeamento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mappings List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Mapeamentos Configurados</h5>
                
                {% if mappings %}
                    <div class="accordion" id="mappingsAccordion">
                        {% for mapping in mappings %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ loop.index }}">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" 
                                            aria-expanded="false">
                                        <div class="d-flex justify-content-between w-100 me-3">
                                            <div>
                                                <strong>{{ mapping.rotulo_contabil }}</strong>
                                                <span class="badge bg-{{ 'success' if mapping.tipo_transacao == 'entrada' else 'danger' if mapping.tipo_transacao == 'saida' else 'secondary' }} ms-2">
                                                    {{ mapping.tipo_transacao.title() }}
                                                </span>
                                            </div>
                                            <div class="text-muted small">
                                                {{ mapping.palavras_chave|join(', ') }}
                                            </div>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" 
                                     data-bs-parent="#mappingsAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Informações Básicas</h6>
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td><strong>Descrição:</strong></td>
                                                        <td>{{ mapping.descricao_longa or 'Não informado' }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Tipo:</strong></td>
                                                        <td>{{ mapping.tipo_transacao.title() }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Palavras-chave:</strong></td>
                                                        <td>
                                                            {% for palavra in mapping.palavras_chave %}
                                                                <span class="badge bg-info">{{ palavra }}</span>
                                                            {% endfor %}
                                                        </td>
                                                    </tr>
                                                    {% if mapping.regex_avancado %}
                                                        <tr>
                                                            <td><strong>Regex Avançado:</strong></td>
                                                            <td><code>{{ mapping.regex_avancado }}</code></td>
                                                        </tr>
                                                    {% endif %}
                                                    {% if mapping.excecoes %}
                                                        <tr>
                                                            <td><strong>Exceções:</strong></td>
                                                            <td>
                                                                {% for excecao in mapping.excecoes %}
                                                                    <span class="badge bg-warning">{{ excecao }}</span>
                                                                {% endfor %}
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Configuração Contábil</h6>
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td><strong>Conta Débito:</strong></td>
                                                        <td><code>{{ mapping.conta_debito }}</code></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Conta Crédito:</strong></td>
                                                        <td><code>{{ mapping.conta_credito }}</code></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Histórico Padrão:</strong></td>
                                                        <td>{{ mapping.historico_contabil_padrao }}</td>
                                                    </tr>
                                                </table>
                                                
                                                {% if mapping.sub_mapeamentos %}
                                                    <h6>Sub-mapeamentos</h6>
                                                    <div class="border rounded p-2">
                                                        {% for sub in mapping.sub_mapeamentos %}
                                                            <div class="mb-2">
                                                                <strong>{{ sub.rotulo_contabil }}</strong>
                                                                <br>
                                                                <small class="text-muted">
                                                                    Palavras-chave: {{ sub.palavras_chave|join(', ') }}
                                                                </small>
                                                                <br>
                                                                <small>
                                                                    Débito: <code>{{ sub.conta_debito }}</code> | 
                                                                    Crédito: <code>{{ sub.conta_credito }}</code>
                                                                </small>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="editMapping('{{ mapping.id }}')">
                                                <i data-feather="edit"></i>
                                                Editar
                                            </button>
                                            <form method="POST" action="{{ url_for('delete_mapping', mapping_id=mapping.id) }}" 
                                                  style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir este mapeamento?')">
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i data-feather="trash-2"></i>
                                                    Excluir
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i data-feather="layers" class="feather-lg text-muted"></i>
                        <p class="text-muted mt-2">Nenhum mapeamento encontrado</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createMappingModal">
                            <i data-feather="plus"></i>
                            Criar Primeiro Mapeamento
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Information -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i data-feather="info" class="feather-sm text-info"></i>
                    Como Funcionam os Mapeamentos
                </h5>
                <p class="text-muted">
                    Os mapeamentos contábeis definem como as transações são automaticamente classificadas e 
                    atribuídas às contas contábeis corretas. O sistema usa uma ordem de prioridade:
                </p>
                <ol class="text-muted">
                    <li><strong>Regras Personalizadas:</strong> Criadas pelo usuário para casos específicos</li>
                    <li><strong>Regex Avançado:</strong> Padrões complexos de correspondência (3 pontos)</li>
                    <li><strong>Palavras-chave de Sub-mapeamentos:</strong> Correspondências específicas (2 pontos)</li>
                    <li><strong>Palavras-chave Principais:</strong> Correspondências gerais (1 ponto)</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Create Mapping Modal -->
<div class="modal fade" id="createMappingModal" tabindex="-1" aria-labelledby="createMappingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createMappingModalLabel">Criar Mapeamento Contábil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('create_mapping') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rotulo_contabil" class="form-label">Rótulo Contábil</label>
                        <input type="text" class="form-control" id="rotulo_contabil" name="rotulo_contabil" required
                               placeholder="ex: Despesas com Salários">
                    </div>
                    
                    <div class="mb-3">
                        <label for="descricao_longa" class="form-label">Descrição Detalhada</label>
                        <textarea class="form-control" id="descricao_longa" name="descricao_longa" rows="2"
                                  placeholder="Descrição detalhada deste mapeamento contábil"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tipo_transacao" class="form-label">Tipo de Transação</label>
                        <select class="form-select" id="tipo_transacao" name="tipo_transacao" required>
                            <option value="">Selecione o tipo</option>
                            <option value="entrada">Entrada (Crédito)</option>
                            <option value="saida">Saída (Débito)</option>
                            <option value="neutro">Neutro (Transferência)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="palavras_chave" class="form-label">Palavras-chave</label>
                        <input type="text" class="form-control" id="palavras_chave" name="palavras_chave" required
                               placeholder="salario,ordenado,folha,pagamento (separadas por vírgula)">
                        <div class="form-text">Liste as palavras-chave separadas por vírgula</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="regex_avancado" class="form-label">Regex Avançado (Opcional)</label>
                        <input type="text" class="form-control" id="regex_avancado" name="regex_avancado"
                               placeholder="Padrão regex para correspondências mais complexas">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="conta_debito" class="form-label">Conta Débito</label>
                                <input type="text" class="form-control" id="conta_debito" name="conta_debito" required
                                       placeholder="ex: 3.1.1.01.001">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="conta_credito" class="form-label">Conta Crédito</label>
                                <input type="text" class="form-control" id="conta_credito" name="conta_credito" required
                                       placeholder="ex: 1.1.1.02.001">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="historico_contabil_padrao" class="form-label">Histórico Padrão</label>
                        <input type="text" class="form-control" id="historico_contabil_padrao" name="historico_contabil_padrao"
                               placeholder="Texto padrão para o histórico contábil">
                    </div>
                    
                    <div class="mb-3">
                        <label for="excecoes" class="form-label">Exceções (Opcional)</label>
                        <input type="text" class="form-control" id="excecoes" name="excecoes"
                               placeholder="palavras que excluem este mapeamento (separadas por vírgula)">
                        <div class="form-text">Palavras que, se presentes, excluem este mapeamento</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Mapeamento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Mapping Modal -->
<div class="modal fade" id="editMappingModal" tabindex="-1" aria-labelledby="editMappingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMappingModalLabel">Editar Mapeamento Contábil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editMappingForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_rotulo_contabil" class="form-label">Rótulo Contábil</label>
                        <input type="text" class="form-control" id="edit_rotulo_contabil" name="rotulo_contabil" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_descricao_longa" class="form-label">Descrição Detalhada</label>
                        <textarea class="form-control" id="edit_descricao_longa" name="descricao_longa" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_tipo_transacao" class="form-label">Tipo de Transação</label>
                        <select class="form-select" id="edit_tipo_transacao" name="tipo_transacao" required>
                            <option value="">Selecione o tipo</option>
                            <option value="entrada">Entrada (Crédito)</option>
                            <option value="saida">Saída (Débito)</option>
                            <option value="neutro">Neutro (Transferência)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_palavras_chave" class="form-label">Palavras-chave</label>
                        <input type="text" class="form-control" id="edit_palavras_chave" name="palavras_chave" required>
                        <div class="form-text">Liste as palavras-chave separadas por vírgula</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_regex_avancado" class="form-label">Regex Avançado (Opcional)</label>
                        <input type="text" class="form-control" id="edit_regex_avancado" name="regex_avancado">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_conta_debito" class="form-label">Conta Débito</label>
                                <input type="text" class="form-control" id="edit_conta_debito" name="conta_debito" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_conta_credito" class="form-label">Conta Crédito</label>
                                <input type="text" class="form-control" id="edit_conta_credito" name="conta_credito" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_historico_contabil_padrao" class="form-label">Histórico Padrão</label>
                        <input type="text" class="form-control" id="edit_historico_contabil_padrao" name="historico_contabil_padrao">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_excecoes" class="form-label">Exceções (Opcional)</label>
                        <input type="text" class="form-control" id="edit_excecoes" name="excecoes">
                        <div class="form-text">Palavras que, se presentes, excluem este mapeamento</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preset Modal -->
<div class="modal fade" id="presetModal" tabindex="-1" aria-labelledby="presetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="presetModalLabel">Gerenciar Presets</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Save New Preset Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i data-feather="save"></i>
                            Salvar Configuração Atual
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="preset_name" class="form-label">Nome do Preset</label>
                            <input type="text" class="form-control" id="preset_name" 
                                   placeholder="ex: Padrão Empresa Comercial">
                        </div>
                        
                        <div class="mb-3">
                            <label for="preset_description" class="form-label">Descrição (Opcional)</label>
                            <textarea class="form-control" id="preset_description" rows="2"
                                      placeholder="Descrição detalhada do preset"></textarea>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="saveCurrentPreset()">
                            <i data-feather="save"></i>
                            Salvar Configuração Atual como Preset
                        </button>
                    </div>
                </div>
                
                <!-- Load Existing Preset Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i data-feather="upload"></i>
                            Carregar Preset Existente
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3" id="presets-loading">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <span class="ms-2">Carregando presets...</span>
                            </div>
                        </div>
                        
                        <div class="mb-3 d-none" id="presets-content">
                            <label for="preset_list" class="form-label">Presets Disponíveis</label>
                            <div id="preset_list" class="list-group">
                                <!-- Presets will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="d-none" id="no-presets">
                            <div class="text-center text-muted">
                                <i data-feather="package"></i>
                                <p class="mt-2">Nenhum preset encontrado</p>
                                <small>Salve sua primeira configuração para criar um preset</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editMapping(mappingId) {
    // Fetch mapping data
    fetch(`/mappings/get/${mappingId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Erro: ' + data.error);
                return;
            }
            
            // Populate form
            document.getElementById('edit_rotulo_contabil').value = data.rotulo_contabil || '';
            document.getElementById('edit_descricao_longa').value = data.descricao_longa || '';
            document.getElementById('edit_tipo_transacao').value = data.tipo_transacao || '';
            document.getElementById('edit_palavras_chave').value = (data.palavras_chave || []).join(', ');
            document.getElementById('edit_regex_avancado').value = data.regex_avancado || '';
            document.getElementById('edit_conta_debito').value = data.conta_debito || '';
            document.getElementById('edit_conta_credito').value = data.conta_credito || '';
            document.getElementById('edit_historico_contabil_padrao').value = data.historico_contabil_padrao || '';
            document.getElementById('edit_excecoes').value = (data.excecoes || []).join(', ');
            
            // Set form action
            document.getElementById('editMappingForm').action = `/mappings/edit/${mappingId}`;
            
            // Show modal
            const editModal = new bootstrap.Modal(document.getElementById('editMappingModal'));
            editModal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao carregar dados do mapeamento');
        });
}

function saveCurrentPreset() {
    const presetName = document.getElementById('preset_name').value.trim();
    const presetDescription = document.getElementById('preset_description').value.trim();
    
    if (!presetName) {
        alert('Por favor, informe um nome para o preset');
        return;
    }
    
    if (confirm(`Salvar configuração atual como "${presetName}"?`)) {
        fetch('/mappings/presets/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: presetName,
                description: presetDescription
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                document.getElementById('preset_name').value = '';
                document.getElementById('preset_description').value = '';
                loadPresetsList(); // Refresh the presets list
            } else {
                alert('Erro: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao salvar preset');
        });
    }
}

function loadPreset(presetId, presetName) {
    if (confirm(`Carregar o preset "${presetName}"? Isso substituirá a configuração atual de mapeamentos.`)) {
        fetch(`/mappings/presets/load/${presetId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Reload the page to show new mappings
                window.location.reload();
            } else {
                alert('Erro: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao carregar preset');
        });
    }
}

function deletePreset(presetId, presetName) {
    if (confirm(`Tem certeza que deseja excluir o preset "${presetName}"?`)) {
        fetch(`/mappings/presets/delete/${presetId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                loadPresetsList(); // Refresh the presets list
            } else {
                alert('Erro: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao excluir preset');
        });
    }
}

function loadPresetsList() {
    const loadingDiv = document.getElementById('presets-loading');
    const contentDiv = document.getElementById('presets-content');
    const noPresetsDiv = document.getElementById('no-presets');
    const presetListDiv = document.getElementById('preset_list');
    
    // Show loading
    loadingDiv.classList.remove('d-none');
    contentDiv.classList.add('d-none');
    noPresetsDiv.classList.add('d-none');
    
    fetch('/mappings/presets/list')
        .then(response => response.json())
        .then(presets => {
            loadingDiv.classList.add('d-none');
            
            if (presets.length === 0) {
                noPresetsDiv.classList.remove('d-none');
                return;
            }
            
            // Clear existing presets
            presetListDiv.innerHTML = '';
            
            // Add each preset
            presets.forEach(preset => {
                const presetItem = document.createElement('div');
                presetItem.className = 'list-group-item d-flex justify-content-between align-items-start';
                
                presetItem.innerHTML = `
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${preset.name}</h6>
                        <p class="mb-1 text-muted small">${preset.description || 'Sem descrição'}</p>
                        <small class="text-muted">
                            ${preset.mappings_count} mapeamentos • 
                            Criado em: ${preset.created_at ? new Date(preset.created_at).toLocaleDateString('pt-BR') : 'Data não informada'}
                        </small>
                    </div>
                    <div class="btn-group-vertical btn-group-sm">
                        <button class="btn btn-outline-success btn-sm" onclick="loadPreset('${preset.id}', '${preset.name}')" title="Carregar">
                            <i data-feather="upload" style="width: 14px; height: 14px;"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deletePreset('${preset.id}', '${preset.name}')" title="Excluir">
                            <i data-feather="trash-2" style="width: 14px; height: 14px;"></i>
                        </button>
                    </div>
                `;
                
                presetListDiv.appendChild(presetItem);
            });
            
            // Re-initialize feather icons for new content
            feather.replace();
            
            contentDiv.classList.remove('d-none');
        })
        .catch(error => {
            console.error('Error:', error);
            loadingDiv.classList.add('d-none');
            noPresetsDiv.classList.remove('d-none');
        });
}

// Load presets list when modal is shown
document.getElementById('presetModal').addEventListener('show.bs.modal', function () {
    loadPresetsList();
});
</script>
{% endblock %}
